# CVE-2023-0179 
## Documentation on editing kernel config (.config) file to support binary analysis.

### Source code analysis
We are interested in then function `nft_verdict_init` found in `linux-6.x.x/net/netfilter/nf_tables_api.c` as that function is the vulnerable function.

### Setting up .config file
We need to setup the .config file to   
**enable** `CONFIG_USER_NS`, `CONFIG_NF_TABLES`  
**disable** `CONFIG_INIT_ON_ALLOC_DEFAULT_ON`.  
As documented in the [CVE report](https://github.com/Notselwyn/CVE-2024-1086).  
This is done using the following command:  
In kernel root directory i.e `linux-6.x.x`  
```
make menuconfig
```
his will open up the menu configurator.  
We need to configure a few things to make sure the kernel is built so that we can easily analyse it using a decompiler later.  
All the following commands are started from the `Linux/x86 6.x.x Kernel Configuration` page (the first page you see when you `make menuconfig`)  
1. Kernel hacking --> Compile-time checks and compiler options --> Debug information --> Select `Rely on the toolchina's implicit default DWARF version`  
This will ensure that the kernel will compile with debug headers so that our decompiler can identify the functions later.
2. Networking support --> Networking options --> Enable `Network packet filtering framework (Netfilter)` --> Enable `Advanced netfilter configuration` --> Core Netfilter Configuration --> Set `netfilter nf_tables support` to `M`  
This will enable `CONFIG_NF_TABLES` and `CONFIG_NETFILTER`, and will modularise the nf_tables module into a `.ko` kernel module file for easy investigation later.  

Save and Exit the menuconfig.

Then configure the `.config` file to enable `CONFIG_USER_NS` and disable `CONFIG_INIT_ON_ALLOC_DEFAULT_ON`.
```
nvim .config
```
Search for `CONFIG_USER_NS`, set it to `CONFIG_USER_NS=y`  
Search for `CONFIG_INIT_ON_ALLOC_DEFAULT_ON`, set it to `# CONFIG_INIT_ON_ALLOC_DEFAULT_ON is not set`

### Ensuring compiler is set to no-inline
Since we want to investigate the function `nft_verdict_init`, but it is inlined by the kernel compiler upon build, we have to manually set the no-inline parameter to the compilation of `nf_tables_api.c`.  
This can be done with the following steps:  
1. In the `linux-6.x.x/net/netfilter/` directory:
    ```
    nvim Makefile
    ```
2. Search for `# nf_tables`, which should show something like:
    ```
    # nf_tables
    nf_tables-objs := nf_tables_core.o nf_tables_api.o nft_chain_filter.o \
                    nf_tables_trace.o nft_immediate.o nft_cmp.o nft_range.o \
                    nft_bitwise.o nft_byteorder.o nft_payload.o nft_lookup.o \
                    nft_dynset.o nft_meta.o nft_rt.o nft_exthdr.o nft_last.o \
                    nft_counter.o nft_chain_route.o nf_tables_offload.o \
                    nft_set_hash.o nft_set_bitmap.o nft_set_rbtree.o \
                    nft_set_pipapo.o
    ```
3. Under these lines paste the following:
    ```
    CFLAGS_nf_tables_api.o := -fno-inline
    ```

At the end of this step your Makefile in `linux-6.x.x/net/netfilter` should have this:
```
...

# nf_tables
nf_tables-objs := nf_tables_core.o nf_tables_api.o nft_chain_filter.o \
                  nf_tables_trace.o nft_immediate.o nft_cmp.o nft_range.o \
                  nft_bitwise.o nft_byteorder.o nft_payload.o nft_lookup.o \
                  nft_dynset.o nft_meta.o nft_rt.o nft_exthdr.o nft_last.o \
                  nft_counter.o nft_chain_route.o nf_tables_offload.o \
                  nft_set_hash.o nft_set_bitmap.o nft_set_rbtree.o \
                  nft_set_pipapo.o

CFLAGS_nf_table_api.o := -fno-inline

ifdef CONFIG_X86_64
ifndef CONFIG_UML
nf_tables-objs += nft_set_pipapo_avx2.o
endif
endif

...
```
This will indicate to the kernel to compile the `nf_tables.ko` kernel module file without inlining any fuctions in the `nft_payload.c` file.
### Compiling the kernel
In the kernel root directory, i.e `linux-6.x.x/`,  
Run the make kernel with the following command:
```
sudo make -j(nproc)
```